<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	定义-日志（2） - lengthuo
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="lengthuo" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	<script src="asset/highlightjs/highlight.pack.js"></script>
	<link href="asset/highlightjs/styles/solarized_dark.css" media="screen, projection" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}

	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
				 
					
					<h1><a href="index.html">lengthuo</a></h1>
					<p class="subtitle">路漫漫其修远兮吾将上下而求索</p>
					<nav id="main-nav">
						<ul class="main">
						
						  <li id=""><a target="self" href="index.html">Home</a></li>
						
						  <li id=""><a target="_self" href="archives.html">Archives</a></li>
						
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">













								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">

	<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
		<h1 class="title" itemprop="name">定义-日志（2）</h1>
		<div class="entry-content" itemprop="articleBody">
			<ol>
<li>请求进入 请求返回 都添加日志 （日志跟踪更详细）</li>
<li>日志需要接入elk（日志分析）</li>
</ol>

<h3 id="toc_0">生成日志唯一标示</h3>

<pre><code>namespace App\Tools\LogWrite;

class GenerateId
{

    /**
     * @return string 生成唯一id
     */
    public static function getGuid()
    {
        mt_srand((double)microtime() * 10000);//optional for php 4.2.0 and up.
        $charid = strtoupper(md5(uniqid(rand(), true)));
        $hyphen = chr(45);// &quot;-&quot;
        $uuid = substr($charid, 0, 8) . $hyphen
            . substr($charid, 8, 4) . $hyphen
            . substr($charid, 12, 4) . $hyphen
            . substr($charid, 16, 4) . $hyphen
            . substr($charid, 20, 12);
        return $uuid;
    }
}

</code></pre>

<h3 id="toc_1">日志方法修改</h3>

<pre><code>&lt;?php

namespace App\Tools\LogWrite;

/**
 * 记录请求日志,为中间件定制(专门在中间件使用  记录东西过多，后期可以去除不表要的参数)
 * Class LogBeforeAndAfter
 * @package App\Tools\LogWrite
 */
class LogBeforeAndAfter
{

    public function logBefore($request)
    {
        $logData = $this-&gt;parseHeaders($request);
        $logData[&#39;type&#39;] = &#39;request&#39;;
        $logData[&#39;data&#39;] = $request-&gt;all();
        LogWrite::info($logData);
    }

    public function logAfter($request, $response)
    {
        $logData = $this-&gt;parseHeaders($request);
        $logData[&#39;type&#39;] = &#39;response&#39;;
        $logData[&#39;data&#39;] = json_decode($response-&gt;getContent(), true);
        LogWrite::info($logData);
    }

    private function parseHeaders($request)
    {
        $headers = $request-&gt;header();
        $logData = [];
        $logData[&#39;host&#39;] = array_get($headers, &#39;host&#39;, [&#39;&#39;])[0];
        $logData[&#39;user-agent&#39;] = array_get($headers, &#39;user-agent&#39;, [&#39;&#39;])[0];
        $logData[&#39;accept&#39;] = array_get($headers, &#39;accept&#39;, [&#39;&#39;])[0];
        $logData[&#39;content-type&#39;] = array_get($headers, &#39;content-type&#39;, [&#39;&#39;])[0];
        return $logData;
    }


}

</code></pre>

<h3 id="toc_2">日志类</h3>

<pre><code>

&lt;?php

namespace App\Tools\LogWrite;

use Illuminate\Log\Writer;
use Illuminate\Support\Facades\Input;
use Illuminate\Support\Facades\Log;
//use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Request;
use Monolog\Logger;

/**
 * 日志记录类
 * Class LogWrite
 * @package App\Tools\LogWrite
 */
class LogWrite
{

    private $loggers = array();
    private static $log;
    private $guid;
//    private $sessionId;
    private $uid;

    private function __construct()
    {
        $this-&gt;guid = GenerateId::getGuid();
//        $this-&gt;sessionId = Session::getId();
//        $loginInfo = getLoginInfoWithoutAuto(&#39;loginInfo&#39;);
//        $this-&gt;uid = isset($loginInfo[&#39;uid&#39;]) &amp;&amp; !empty($loginInfo[&#39;uid&#39;]) ? $loginInfo[&#39;uid&#39;] : 0;
    }

    private function getLogger($type, $day = 30)
    {
        if (empty($this-&gt;loggers[$type])) {
            $this-&gt;loggers[$type] = new Writer(new Logger($type));
            $logPath = env(&#39;LOG_PATH&#39;, storage_path() . &#39;/logs&#39;) . &#39;/&#39;;
            $this-&gt;loggers[$type]-&gt;useDailyFiles($logPath . env(&#39;APP_NAME&#39;, &#39;center&#39;) . &#39;.&#39; . $type . &#39;.log&#39;, $day);
        }
        return $this-&gt;loggers[$type];
    }

    private function doLog($name, $level, $data)
    {
        $data[&#39;guid&#39;] = $this-&gt;guid;
//        $data[&#39;sessionId&#39;] = $this-&gt;sessionId;
//        $data[&#39;uid&#39;] = $this-&gt;uid;
        $loger = $this-&gt;getLogger($name);
        $loger-&gt;$level(json_encode($data, JSON_UNESCAPED_UNICODE));
    }


    public static function log()
    {
        if (self::$log) {
            return self::$log;
        }
        self::$log = new self();
        return self::$log;
    }

    public static function info(array $data, $name = __FUNCTION__, $level = __FUNCTION__)
    {
        self::log()-&gt;doLog($name, $level, $data);
    }

    public static function error(array $data, $name = __FUNCTION__, $level = __FUNCTION__)
    {

        self::log()-&gt;doLog($name, $level, $data);

    }

    public static function exception(\Exception $exception, $request = null)
    {
        $errLog = [
            &#39;type&#39; =&gt; &#39;error&#39;,
            &#39;remoteAddr&#39; =&gt; &#39;&#39;,
            &#39;remotePort&#39; =&gt; &#39;&#39;,
            &#39;referer&#39; =&gt; &#39;&#39;,
            &#39;url&#39; =&gt; &#39;&#39;,
            &#39;input&#39; =&gt; [],
            &#39;message&#39; =&gt; &#39;&#39;,
            &#39;file&#39; =&gt; &#39;&#39;,
            &#39;line&#39; =&gt; &#39;&#39;,
            &#39;code&#39; =&gt; &#39;&#39;,
            &#39;trace&#39; =&gt; [],
            &#39;exceptionClass&#39; =&gt; &#39;&#39;,
        ];
        $errLog[&#39;remoteAddr&#39;] = isset($_SERVER[&#39;REMOTE_ADDR&#39;]) &amp;&amp; !empty($_SERVER[&#39;REMOTE_ADDR&#39;]) ? $_SERVER[&#39;REMOTE_ADDR&#39;] : &#39;&#39;;
        $errLog[&#39;remotePort&#39;] = isset($_SERVER[&#39;REMOTE_PORT&#39;]) &amp;&amp; !empty($_SERVER[&#39;REMOTE_PORT&#39;]) ? $_SERVER[&#39;REMOTE_PORT&#39;] : &#39;&#39;;
        $errLog[&#39;referer&#39;] = isset($_SERVER[&#39;HTTP_REFERER&#39;]) &amp;&amp; !empty($_SERVER[&#39;HTTP_REFERER&#39;]) ? $_SERVER[&#39;HTTP_REFERER&#39;] : &#39;&#39;;
        $errLog[&#39;url&#39;] = Request::url() ?: &#39;&#39;;
        $errLog[&#39;input&#39;] = Input::all() ?: [];
        $errLog[&#39;message&#39;] = $exception-&gt;getMessage();
        $errLog[&#39;file&#39;] = $exception-&gt;getFile();
        $errLog[&#39;line&#39;] = $exception-&gt;getLine();
        $errLog[&#39;code&#39;] = $exception-&gt;getCode();
//            $errLog[&#39;trace&#39;] = $exception-&gt;getTrace();
        $errLog[&#39;exceptionClass&#39;] = get_class($exception);
        self::error($errLog);
    }


}

</code></pre>

<h3 id="toc_3">前置中间件</h3>

<pre><code>&lt;?php

namespace App\Http\Middleware;

use App\Tools\LogWrite\LogBeforeAndAfter;
use App\Tools\LogWrite\LogWrite;
use Closure;

class LogBefore
{
    /**
     * @desc 将请求信息写入日志
     * @param $request
     * @param Closure $next
     */
    public function handle($request, Closure $next)
    {
        try {
            (new LogBeforeAndAfter())-&gt;logBefore($request);
        } catch (\Exception $e) {
            $logData = [&#39;type&#39; =&gt; &#39;error&#39;];
            LogWrite::error($logData);
        }
        return $next($request);
    }
}


</code></pre>

<h3 id="toc_4">后置中间件</h3>

<pre><code>
&lt;?php

namespace App\Http\Middleware;

use App\Tools\LogWrite\LogBeforeAndAfter;
use App\Tools\LogWrite\LogWrite;
use Closure;

class LogAfter
{
    /**
     * @desc 将请求信息写入日志
     * @param $request
     * @param Closure $next
     */
    public function handle($request, Closure $next)
    {
        $response = $next($request);
        try {
            (new LogBeforeAndAfter())-&gt;logAfter($request, $response);
        } catch (\Exception $e) {
            $logData = [&#39;type&#39; =&gt; &#39;error&#39;];
            LogWrite::error($logData);
        }
        return $response;
    }
}


</code></pre>

<h3 id="toc_5">修改kernel</h3>

<pre><code>
 /**
    * The application&#39;s global HTTP middleware stack.
    *
    * These middleware are run during every request to your application.
    */
protected $middleware = [
        //追加2项
        \App\Http\Middleware\LogBefore::class,  
        \App\Http\Middleware\LogAfter::class,   
    ];

</code></pre>

<h3 id="toc_6">调用实例</h3>

<pre><code>
 LogWrite::info([&quot;test&quot;=&gt;&quot;测试请求&quot;]);
 LogWrite::error([&quot;test&quot;=&gt;&quot;error&quot;]);
 LogWrite::exception(new \Exception(),[&quot;test&quot;=&gt;&quot;exception&quot;]);
 

</code></pre>

<h3 id="toc_7">日志信息</h3>

<pre><code>生成2个文件
xxx 为中心的名称（为了elk接入之后方便区分是哪个中心的日志）
xxx.info

[2017-11-03 10:46:00] info.INFO: {&quot;host&quot;:&quot;localhost&quot;,&quot;user-agent&quot;:&quot;Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/61.0.3163.100 Safari\/537.36&quot;,&quot;accept&quot;:&quot;text\/html,application\/xhtml+xml,application\/xml;q=0.9,image\/webp,image\/apng,*\/*;q=0.8&quot;,&quot;content-type&quot;:&quot;&quot;,&quot;type&quot;:&quot;request&quot;,&quot;data&quot;:[],&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  
[2017-11-03 10:46:00] info.INFO: {&quot;test&quot;:&quot;测试请求&quot;,&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  
[2017-11-03 10:46:00] info.INFO: {&quot;host&quot;:&quot;localhost&quot;,&quot;user-agent&quot;:&quot;Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/61.0.3163.100 Safari\/537.36&quot;,&quot;accept&quot;:&quot;text\/html,application\/xhtml+xml,application\/xml;q=0.9,image\/webp,image\/apng,*\/*;q=0.8&quot;,&quot;content-type&quot;:&quot;&quot;,&quot;type&quot;:&quot;response&quot;,&quot;data&quot;:{&quot;hello&quot;:&quot;word&quot;},&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  


xxx.error  

exception 只是组装自己的参数，最后还是调用error方法 ，所以日志有2条

[2017-11-03 10:46:00] error.ERROR: {&quot;test&quot;:&quot;error&quot;,&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  
[2017-11-03 10:46:00] error.ERROR: {&quot;type&quot;:&quot;error&quot;,&quot;remoteAddr&quot;:&quot;::1&quot;,&quot;remotePort&quot;:&quot;62126&quot;,&quot;referer&quot;:&quot;&quot;,&quot;url&quot;:&quot;http:\/\/localhost\/eking_platformwallet_center\/public\/test&quot;,&quot;input&quot;:[],&quot;message&quot;:&quot;&quot;,&quot;file&quot;:&quot;\/Users\/shuo\/w3c\/eking_platformwallet_center\/app\/Http\/Controllers\/TestController.php&quot;,&quot;line&quot;:14,&quot;code&quot;:0,&quot;trace&quot;:[],&quot;exceptionClass&quot;:&quot;Exception&quot;,&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  



</code></pre>

		</div>
	</article>
	<div class="share-comment">
	 

	  

	  

	</div>
</div>        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>

  
    
<script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

</body>
</html>