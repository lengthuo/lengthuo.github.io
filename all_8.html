<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>  
	  
  	lengthuo
  	
	</title>

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="atom.xml" rel="alternate" title="lengthuo" type="application/atom+xml">

	<link href="asset/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="asset/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<script src="asset/javascripts/jquery.min.js"></script>
	<script src="asset/highlightjs/highlight.pack.js"></script>
	<link href="asset/highlightjs/styles/solarized_dark.css" media="screen, projection" rel="stylesheet" type="text/css">
<script>hljs.initHighlightingOnLoad();</script>

	<!--[if lt IE 9]><script src="asset/javascripts/html5.js"></script><![endif]-->
	<!-- <link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 300;
  src: local('Nunito-Light'), url(asset/font/1TiHc9yag0wq3lDO9cw0voX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 400;
  src: local('Nunito-Regular'), url(asset/font/6TbRXKWJjpj6V2v_WyRbMX-_kf6ByYO6CLYdB4HQE-Y.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
/* latin */
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Nunito-Bold'), url(asset/font/TttUCfJ272GBgSKaOaD7KoX0hVgzZQUfRDuZrPvH3D8.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
	</style>
	
	<style type="text/css">
	.container .left-col{ opacity: 1;}
	#pagenavi a{ font-size: 1.3em;}
	#pagenavi .next:before{ top: 3px;}
	#pagenavi .prev:before{ top: 3px;}
	.container .mid-col .mid-col-container #content .archives .title{ font-size: 1.5em;}
	.container .mid-col .mid-col-container #content article{ padding: 15px 0px;}
	#header .subtitle {
		line-height: 1.2em;
		padding-top: 8px;
	}
	article pre{ background: none; border: none; padding: 0;}
	article .entry-content{text-align: left;}
	.share-comment{ padding: 25px 0px; clear: both;}
	hr{ margin: 20px 0px;border: 0; border-top:solid 1px #ddd;}

	</style>
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner">
				 
					
					<h1><a href="index.html">lengthuo</a></h1>
					<p class="subtitle">路漫漫其修远兮吾将上下而求索</p>
					<nav id="main-nav">
						<ul class="main">
						
						  <li id=""><a target="self" href="index.html">Home</a></li>
						
						  <li id=""><a target="_self" href="archives.html">Archives</a></li>
						
						</ul>
					</nav>

					<nav id="sub-nav">
						<div class="social">













								

								<a class="rss" href="atom.xml" title="RSS">RSS</a>
							
						</div>
					</nav>
				</header>				
			</div>
		</div>	
		<div class="mid-col">
			<div class="mid-col-container"> <div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-11-03T17:47:35+08:00" itemprop="datePublished">2017/11/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%87%91%E8%9E%8D%E4%BA%91%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html'>金融云解决方案</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15097024555685.html" itemprop="url">
		文档-初始化项目流程</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<h3 id="toc_0">1 laravel版本统一 5.4.*</h3>

<h3 id="toc_1">2 mysql 配置</h3>

<pre><code>支持 proxy.sql 代理操作
&#39;mysql&#39; =&gt; [
            &#39;driver&#39; =&gt; &#39;mysql&#39;,
            &#39;host&#39; =&gt; env(&#39;DB_HOST&#39;, &#39;127.0.0.1&#39;),
            &#39;port&#39; =&gt; env(&#39;DB_PORT&#39;, &#39;3306&#39;),
            &#39;database&#39; =&gt; env(&#39;DB_DATABASE&#39;, &#39;forge&#39;),
            &#39;username&#39; =&gt; env(&#39;DB_USERNAME&#39;, &#39;forge&#39;),
            &#39;password&#39; =&gt; env(&#39;DB_PASSWORD&#39;, &#39;&#39;),
            &#39;charset&#39; =&gt; &#39;utf8mb4&#39;,
            &#39;collation&#39; =&gt; &#39;utf8mb4_unicode_ci&#39;,
            &#39;prefix&#39; =&gt; &#39;&#39;,
            &#39;strict&#39; =&gt; true,
            &#39;engine&#39; =&gt; null,
            &#39;options&#39;  =&gt; [
                PDO::MYSQL_ATTR_INIT_COMMAND =&gt; &#39;SET NAMES utf8&#39;,   //增加字符集
                PDO::ATTR_EMULATE_PREPARES =&gt; true,// 禁用PDO预处理功能
            ]
        ],
        
        
        
</code></pre>

<h3 id="toc_2">3 redis配置</h3>

<pre><code> &#39;redis&#39; =&gt; [

        &#39;client&#39; =&gt; &#39;predis&#39;,

        &#39;default&#39; =&gt; [
            &#39;host&#39; =&gt; env(&#39;REDIS_HOST&#39;, &#39;127.0.0.1&#39;),
            &#39;password&#39; =&gt; env(&#39;REDIS_PASSWORD&#39;, null),
            &#39;port&#39; =&gt; env(&#39;REDIS_PORT&#39;, 6379),
            &#39;database&#39; =&gt; 0,
        ],
        
        //配置自己的reids地址 默认是使用数据库0
        &#39;authredis&#39; =&gt; [
            &#39;host&#39; =&gt; env(&#39;AUTH_REDIS_HOST&#39;, &#39;127.0.0.1&#39;),
            &#39;password&#39; =&gt; env(&#39;AUTH_REDIS_PASSWORD&#39;, null),
            &#39;port&#39; =&gt; env(&#39;AUTH_REDIS_PORT&#39;, 6379),
            &#39;database&#39; =&gt; 0,
        ],
    ],
    
    //使用的时候指定使用哪一个redis连接
    
    app(&#39;redis&#39;)-&gt;connection(&#39;authredis&#39;)-&gt;hget(self::$refreshtoken, &#39;dsessionId&#39;);

</code></pre>

<h3 id="toc_3">接口去除自带csrfToken</h3>

<pre><code> app/Http/Kernel.php
 \App\Http\Middleware\VerifyCsrfToken::class,
 
</code></pre>

<h3 id="toc_4">前置后置中间件（请求返回日志）</h3>

<pre><code>app/Http/Kernel.php
\App\Http\Middleware\LogBefore::class,
\App\Http\Middleware\LogAfter::class,

创建middleware
LogBefore
 public function handle($request, Closure $next)
    {
        try {
            (new LogBeforeAndAfter())-&gt;logBefore($request);
        } catch (\Exception $e) {
            $logData = [&#39;type&#39; =&gt; &#39;error&#39;];
            LogWrite::error($logData);
        }
        return $next($request);
    }
LogAfter
 public function handle($request, Closure $next)
    {
        $response = $next($request);
        try {
            (new LogBeforeAndAfter())-&gt;logAfter($request, $response);
        } catch (\Exception $e) {
            $logData = [&#39;type&#39; =&gt; &#39;error&#39;];
            LogWrite::error($logData);
        }
        return $response;
    }

</code></pre>

<h3 id="toc_5">公共类的引入</h3>

<h3 id="toc_6">请求参数的处理</h3>

<pre><code>
 public function handle($request, Closure $next)
    {
        if (!isset($request-&gt;data)) {
            throw new LoginException(&#39;PARAM_INVALID&#39;);
        }
        //由于请求参数是2层json，不利于程序处理，所以统一处理替换请求参数
        $request-&gt;replace($request-&gt;data);
        GeneralLog::write($request-&gt;all(), $request-&gt;getPathInfo());
        return $next($request);
    }
    
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-11-03T18:51:10+08:00" itemprop="datePublished">2017/11/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%87%91%E8%9E%8D%E4%BA%91%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html'>金融云解决方案</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15097062709914.html" itemprop="url">
		定义-返回码</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<p>config/code.php</p>

<ol>
<li>定义常量目的: 是为了方便代码的阅读</li>
<li>定义数字目的: 是返回给调用方的。</li>
<li>每一条都添加2项目的: p2p调用中心出现错误的时候，p2p需要根据状态码找出对应的常量，找出对应的常量的目的：返回方法写死的。都是根据常量获取状态码。</li>
</ol>

<pre><code>throw new CenterException(config(&#39;code.&#39;.$res[ &#39;code&#39; ])); //通过下面对应的关系找到 常量

这很扯... 只需要修改返回方法的处理即可（如果是数字的话，就需要循环找出对应的数字即可）   

</code></pre>

<pre><code>&lt;?php


return [
    1000 =&gt; &quot;SUCCESS&quot;, &#39;SUCCESS&#39; =&gt; [&#39;code&#39; =&gt; 1000, &#39;msg&#39; =&gt; &#39;success&#39;],

    1001 =&gt; &quot;TOKEN_ERROR&quot;, &#39;TOKEN_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 1001, &#39;msg&#39; =&gt; &#39;token不存在，或是已经失效，请从新登录&#39;],

    1002 =&gt; &quot;CENTER_ERROR&quot;, &#39;CENTER_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 1002, &#39;msg&#39; =&gt; &#39;未知错误&#39;], //请求中心错误,数据已返回,但格式错误

    1003 =&gt; &quot;CENTER_REQUEST_NET_ERROR&quot;, &#39;CENTER_REQUEST_NET_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 1003, &#39;msg&#39; =&gt; &#39;内部网络错误&#39;], //请求中心时网络错误

    1004 =&gt; &quot;CENTER_REQUEST_TIME_DNS_ERROR&quot;, &#39;CENTER_REQUEST_TIME_DNS_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 1004, &#39;msg&#39; =&gt; &#39;内部网络错误&#39;], //请求中心时超时 DNS错误

    1005 =&gt; &quot;CENTER_REQUEST_ERROR&quot;, &#39;CENTER_REQUEST_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 1005, &#39;msg&#39; =&gt; &#39;内部网络错误&#39;], //请求中心错误，没有抓到具体哪一类异常

    1006 =&gt; &quot;GETUID_ERROR&quot;, &#39;GETUID_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 1001, &#39;msg&#39; =&gt; &#39;token不存在，或是已经失效，请从新登录&#39;],// userid 溢出/转换为int错误
    /*
    |--------------------------------------------------------------------------
    | 系统错误码
    |--------------------------------------------------------------------------
    |
    */
    // HTTP 客户端请求
    304 =&gt; &#39;CACHE_VALID&#39;, &#39;CACHE_VALID&#39; =&gt; [&#39;code&#39; =&gt; 304, &#39;msg&#39; =&gt; &#39;HTTP缓存有效&#39;],

    400 =&gt; &#39;BAD_REQUEST&#39;, &#39;BAD_REQUEST&#39; =&gt; [&#39;code&#39; =&gt; 400, &#39;msg&#39; =&gt; &#39;请求格式错误&#39;],

    401 =&gt; &#39;AUTH_ERROR&#39;, &#39;AUTH_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 401, &#39;msg&#39; =&gt; &#39;未授权&#39;],

    403 =&gt; &#39;USER_AUTO_ERROR&#39;, &#39;USER_AUTO_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 403, &#39;msg&#39; =&gt; &#39;请求成功，但是该用户没有权限&#39;],

    404 =&gt; &#39;NOT_FOUND&#39;, &#39;NOT_FOUND&#39; =&gt; [&#39;code&#39; =&gt; 404, &#39;msg&#39; =&gt; &#39;请求的资源不存在&#39;],

    405 =&gt; &#39;METHOD_NOT_ALLOWED&#39;, &#39;METHOD_NOT_ALLOWED&#39; =&gt; [&#39;code&#39; =&gt; 405, &#39;msg&#39; =&gt; &#39;该http方法不被允许&#39;],

    410 =&gt; &#39;RESOURCE_NOT_AVAILABLE&#39;, &#39;RESOURCE_NOT_AVAILABLE&#39; =&gt; [&#39;code&#39; =&gt; 410, &#39;msg&#39; =&gt; &#39;这个url对应的资源现在不可用&#39;],

    415 =&gt; &#39;REQUEST_TYPE_ERROR&#39;, &#39;REQUEST_TYPE_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 415, &#39;msg&#39; =&gt; &#39;请求类型错误&#39;],

    422 =&gt; &#39;UNPROCESSABLE_ENTITY&#39;, &#39;UNPROCESSABLE_ENTITY&#39; =&gt; [&#39;code&#39; =&gt; 422, &#39;msg&#39; =&gt; &#39;校验错误时用&#39;],

    429 =&gt; &#39;TOO_MANY_REQUESTS&#39;, &#39;TOO_MANY_REQUESTS&#39; =&gt; [&#39;code&#39; =&gt; 429, &#39;msg&#39; =&gt; &#39;请求过多&#39;],


    // Server Error 5xx
    500 =&gt; &#39;TNTERNAL_SERVER_ERROR&#39;, &#39;TNTERNAL_SERVER_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 500, &#39;msg&#39; =&gt; &#39;Internal Server Error&#39;],

    501 =&gt; &#39;NOT_IMPLEMENTED&#39;, &#39;NOT_IMPLEMENTED&#39; =&gt; [&#39;code&#39; =&gt; 501, &#39;msg&#39; =&gt; &#39;Not Implemented&#39;],

    502 =&gt; &#39;BAD_GATEWAY&#39;, &#39;BAD_GATEWAY&#39; =&gt; [&#39;code&#39; =&gt; 502, &#39;msg&#39; =&gt; &#39;Bad Gateway&#39;],

    503 =&gt; &#39;SERVICE_UNAVAILABLE&#39;, &#39;SERVICE_UNAVAILABLE&#39; =&gt; [&#39;code&#39; =&gt; 503, &#39;msg&#39; =&gt; &#39;Service Unavailable&#39;],

    504 =&gt; &#39;GATWAY_TIMEOUT&#39;, &#39;GATWAY_TIMEOUT&#39; =&gt; [&#39;code&#39; =&gt; 504, &#39;msg&#39; =&gt; &#39;Gateway Timeout&#39;],

    505 =&gt; &#39;HTTP_VERSION_NOT_SUPPORTED&#39;, &#39;HTTP_VERSION_NOT_SUPPORTED&#39; =&gt; [&#39;code&#39; =&gt; 505, &#39;msg&#39; =&gt; &#39;HTTP Version Not Supported&#39;],

    509 =&gt; &#39;BANDWIDTH_LIMIT_EXCEEDED&#39;, &#39;BANDWIDTH_LIMIT_EXCEEDED&#39; =&gt; [&#39;code&#39; =&gt; 509, &#39;msg&#39; =&gt; &#39;Bandwidth Limit Exceeded&#39;],

    /*
    |--------------------------------------------------------------------------
    | 异常 1100 ~
    |--------------------------------------------------------------------------
    |
    */
    //数据库的异常
    1101 =&gt; &#39;DATA_HANDLING_ERROR&#39;, &#39;DATA_HANDLING_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 1101, &#39;msg&#39; =&gt; &#39;数据处理异常&#39;],
    //Redis异常 s
    1201 =&gt; &#39;REDIS_HANDLING_ERROR&#39;, &#39;REDIS_HANDLING_ERROR&#39; =&gt; [&#39;code&#39; =&gt; 1201, &#39;msg&#39; =&gt; &#39;内部缓存异常&#39;],

    /*
    |--------------------------------------------------------------------------
    | 业务错误码 2000~
    |--------------------------------------------------------------------------
    |
    */




</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-11-03T15:22:23+08:00" itemprop="datePublished">2017/11/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%87%91%E8%9E%8D%E4%BA%91%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html'>金融云解决方案</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15096937437171.html" itemprop="url">
		定义-分页</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<pre><code>请求参数
{
  &quot;data&quot;: {
    &quot;limit&quot;: 10,  
    &quot;page&quot;: 1
  }
}

返回参数
{
  &quot;isException&quot;: false,
  &quot;code&quot;: 1000,
  &quot;msg&quot;: &quot;success&quot;,
  &quot;data&quot;: {
    &quot;current_page&quot;: 1,  
    &quot;per_page&quot;: 10,
    &quot;total&quot;: 5,
    &quot;list&quot;: [
      {
        &quot;id&quot;: 5,
        &quot;financier_id&quot;: 1
      },
      {
        &quot;id&quot;: 6,
        &quot;financier_id&quot;: 1
      }
    ]
  }
}


</code></pre>

<pre><code>services :

    $limit = &#39;每页个数&#39;;
    //查询参数组装
     $where = [];
        if (!empty($productName)) {
            $where[] = [&#39;product_name&#39;, &#39;like&#39;, &#39;%&#39; . $productName . &#39;%&#39;];
        }
         
repostory :

        return $this-&gt;productMode-&gt;where($query)
                -&gt;paginate($limit);
    
</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-11-03T18:27:52+08:00" itemprop="datePublished">2017/11/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%87%91%E8%9E%8D%E4%BA%91%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html'>金融云解决方案</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15097048723727.html" itemprop="url">
		定义-日志 （1）</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<pre><code>
&lt;?php
/**
 * Created by PhpStorm.
 * User: Pactera
 * Date: 2017/9/28
 * Time: 10:53
 */

namespace App\BCAM\Log;
use Illuminate\Log\Writer;
use Monolog\Logger;
class GeneralLog
{
 const EXPIRE_DATE = 30; //过期时间
 /**
 * @param array $data 记录的数据
 * @param $name 日志标识
 * @param string $logType 日志类型
 */
 static function write(array $data, $name = &#39;&#39;, $logType = &#39;info&#39;)
 {
 $data[&#39;log_id&#39;] = mt_rand();
 $log = new Writer(new Logger($logType));
 $log-&gt;useDailyFiles(storage_path() . &#39;/logs/&#39; . &#39;log&#39;, self::EXPIRE_DATE);
 $data = array_merge($data, [&#39;request_url&#39; =&gt; url()-&gt;current()]);

 $log-&gt;write($logType, $name, $data);
 }
}


</code></pre>

<p>调用实例：<br/>
GeneralLog::write($data,&#39;请求数据&#39;,“info”);</p>

<pre><code>2017-09-28 10:10:42] info.INFO: 请求数据 {&quot;mobile&quot;:&quot;18302544763&quot;,&quot;password&quot;:&quot;5f6c86ce169952d34586a5c39d3441dc&quot;,&quot;user_type&quot;:1,&quot;reg_ip&quot;:&quot;10.160.20.13&quot;,&quot;request__number&quot;:&quot;ASHDASHDH1342134H32142I34F234DG&quot;,&quot;service_name&quot;:&quot;P2P&quot;,&quot;request_url&quot;:&quot;/api/account/personal/register&quot;,&quot;log_id&quot;:642258748}


</code></pre>


			
			
		</div>

	</article>
 
	<article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="meta">
			<div class="date">
				<time datetime="2017-11-03T17:53:30+08:00" itemprop="datePublished">2017/11/3</time>
			</div>
			<div class="tags">posted in 
			
			    <a class='category' href='%E9%87%91%E8%9E%8D%E4%BA%91%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html'>金融云解决方案</a>&nbsp;
			 
			</div>
		</div>
		<h1 class="title" itemprop="name"><a href="15097028101727.html" itemprop="url">
		定义-日志（2）</a></h1>
		<div class="entry-content" itemprop="articleBody">
			
			<ol>
<li>请求进入 请求返回 都添加日志 （日志跟踪更详细）</li>
<li>日志需要接入elk（日志分析）</li>
</ol>

<h3 id="toc_0">生成日志唯一标示</h3>

<pre><code>namespace App\Tools\LogWrite;

class GenerateId
{

    /**
     * @return string 生成唯一id
     */
    public static function getGuid()
    {
        mt_srand((double)microtime() * 10000);//optional for php 4.2.0 and up.
        $charid = strtoupper(md5(uniqid(rand(), true)));
        $hyphen = chr(45);// &quot;-&quot;
        $uuid = substr($charid, 0, 8) . $hyphen
            . substr($charid, 8, 4) . $hyphen
            . substr($charid, 12, 4) . $hyphen
            . substr($charid, 16, 4) . $hyphen
            . substr($charid, 20, 12);
        return $uuid;
    }
}

</code></pre>

<h3 id="toc_1">日志方法修改</h3>

<pre><code>&lt;?php

namespace App\Tools\LogWrite;

/**
 * 记录请求日志,为中间件定制(专门在中间件使用  记录东西过多，后期可以去除不表要的参数)
 * Class LogBeforeAndAfter
 * @package App\Tools\LogWrite
 */
class LogBeforeAndAfter
{

    public function logBefore($request)
    {
        $logData = $this-&gt;parseHeaders($request);
        $logData[&#39;type&#39;] = &#39;request&#39;;
        $logData[&#39;data&#39;] = $request-&gt;all();
        LogWrite::info($logData);
    }

    public function logAfter($request, $response)
    {
        $logData = $this-&gt;parseHeaders($request);
        $logData[&#39;type&#39;] = &#39;response&#39;;
        $logData[&#39;data&#39;] = json_decode($response-&gt;getContent(), true);
        LogWrite::info($logData);
    }

    private function parseHeaders($request)
    {
        $headers = $request-&gt;header();
        $logData = [];
        $logData[&#39;host&#39;] = array_get($headers, &#39;host&#39;, [&#39;&#39;])[0];
        $logData[&#39;user-agent&#39;] = array_get($headers, &#39;user-agent&#39;, [&#39;&#39;])[0];
        $logData[&#39;accept&#39;] = array_get($headers, &#39;accept&#39;, [&#39;&#39;])[0];
        $logData[&#39;content-type&#39;] = array_get($headers, &#39;content-type&#39;, [&#39;&#39;])[0];
        return $logData;
    }


}

</code></pre>

<h3 id="toc_2">日志类</h3>

<pre><code>

&lt;?php

namespace App\Tools\LogWrite;

use Illuminate\Log\Writer;
use Illuminate\Support\Facades\Input;
use Illuminate\Support\Facades\Log;
//use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Request;
use Monolog\Logger;

/**
 * 日志记录类
 * Class LogWrite
 * @package App\Tools\LogWrite
 */
class LogWrite
{

    private $loggers = array();
    private static $log;
    private $guid;
//    private $sessionId;
    private $uid;

    private function __construct()
    {
        $this-&gt;guid = GenerateId::getGuid();
//        $this-&gt;sessionId = Session::getId();
//        $loginInfo = getLoginInfoWithoutAuto(&#39;loginInfo&#39;);
//        $this-&gt;uid = isset($loginInfo[&#39;uid&#39;]) &amp;&amp; !empty($loginInfo[&#39;uid&#39;]) ? $loginInfo[&#39;uid&#39;] : 0;
    }

    private function getLogger($type, $day = 30)
    {
        if (empty($this-&gt;loggers[$type])) {
            $this-&gt;loggers[$type] = new Writer(new Logger($type));
            $logPath = env(&#39;LOG_PATH&#39;, storage_path() . &#39;/logs&#39;) . &#39;/&#39;;
            $this-&gt;loggers[$type]-&gt;useDailyFiles($logPath . env(&#39;APP_NAME&#39;, &#39;center&#39;) . &#39;.&#39; . $type . &#39;.log&#39;, $day);
        }
        return $this-&gt;loggers[$type];
    }

    private function doLog($name, $level, $data)
    {
        $data[&#39;guid&#39;] = $this-&gt;guid;
//        $data[&#39;sessionId&#39;] = $this-&gt;sessionId;
//        $data[&#39;uid&#39;] = $this-&gt;uid;
        $loger = $this-&gt;getLogger($name);
        $loger-&gt;$level(json_encode($data, JSON_UNESCAPED_UNICODE));
    }


    public static function log()
    {
        if (self::$log) {
            return self::$log;
        }
        self::$log = new self();
        return self::$log;
    }

    public static function info(array $data, $name = __FUNCTION__, $level = __FUNCTION__)
    {
        self::log()-&gt;doLog($name, $level, $data);
    }

    public static function error(array $data, $name = __FUNCTION__, $level = __FUNCTION__)
    {

        self::log()-&gt;doLog($name, $level, $data);

    }

    public static function exception(\Exception $exception, $request = null)
    {
        $errLog = [
            &#39;type&#39; =&gt; &#39;error&#39;,
            &#39;remoteAddr&#39; =&gt; &#39;&#39;,
            &#39;remotePort&#39; =&gt; &#39;&#39;,
            &#39;referer&#39; =&gt; &#39;&#39;,
            &#39;url&#39; =&gt; &#39;&#39;,
            &#39;input&#39; =&gt; [],
            &#39;message&#39; =&gt; &#39;&#39;,
            &#39;file&#39; =&gt; &#39;&#39;,
            &#39;line&#39; =&gt; &#39;&#39;,
            &#39;code&#39; =&gt; &#39;&#39;,
            &#39;trace&#39; =&gt; [],
            &#39;exceptionClass&#39; =&gt; &#39;&#39;,
        ];
        $errLog[&#39;remoteAddr&#39;] = isset($_SERVER[&#39;REMOTE_ADDR&#39;]) &amp;&amp; !empty($_SERVER[&#39;REMOTE_ADDR&#39;]) ? $_SERVER[&#39;REMOTE_ADDR&#39;] : &#39;&#39;;
        $errLog[&#39;remotePort&#39;] = isset($_SERVER[&#39;REMOTE_PORT&#39;]) &amp;&amp; !empty($_SERVER[&#39;REMOTE_PORT&#39;]) ? $_SERVER[&#39;REMOTE_PORT&#39;] : &#39;&#39;;
        $errLog[&#39;referer&#39;] = isset($_SERVER[&#39;HTTP_REFERER&#39;]) &amp;&amp; !empty($_SERVER[&#39;HTTP_REFERER&#39;]) ? $_SERVER[&#39;HTTP_REFERER&#39;] : &#39;&#39;;
        $errLog[&#39;url&#39;] = Request::url() ?: &#39;&#39;;
        $errLog[&#39;input&#39;] = Input::all() ?: [];
        $errLog[&#39;message&#39;] = $exception-&gt;getMessage();
        $errLog[&#39;file&#39;] = $exception-&gt;getFile();
        $errLog[&#39;line&#39;] = $exception-&gt;getLine();
        $errLog[&#39;code&#39;] = $exception-&gt;getCode();
//            $errLog[&#39;trace&#39;] = $exception-&gt;getTrace();
        $errLog[&#39;exceptionClass&#39;] = get_class($exception);
        self::error($errLog);
    }


}

</code></pre>

<h3 id="toc_3">前置中间件</h3>

<pre><code>&lt;?php

namespace App\Http\Middleware;

use App\Tools\LogWrite\LogBeforeAndAfter;
use App\Tools\LogWrite\LogWrite;
use Closure;

class LogBefore
{
    /**
     * @desc 将请求信息写入日志
     * @param $request
     * @param Closure $next
     */
    public function handle($request, Closure $next)
    {
        try {
            (new LogBeforeAndAfter())-&gt;logBefore($request);
        } catch (\Exception $e) {
            $logData = [&#39;type&#39; =&gt; &#39;error&#39;];
            LogWrite::error($logData);
        }
        return $next($request);
    }
}


</code></pre>

<h3 id="toc_4">后置中间件</h3>

<pre><code>
&lt;?php

namespace App\Http\Middleware;

use App\Tools\LogWrite\LogBeforeAndAfter;
use App\Tools\LogWrite\LogWrite;
use Closure;

class LogAfter
{
    /**
     * @desc 将请求信息写入日志
     * @param $request
     * @param Closure $next
     */
    public function handle($request, Closure $next)
    {
        $response = $next($request);
        try {
            (new LogBeforeAndAfter())-&gt;logAfter($request, $response);
        } catch (\Exception $e) {
            $logData = [&#39;type&#39; =&gt; &#39;error&#39;];
            LogWrite::error($logData);
        }
        return $response;
    }
}


</code></pre>

<h3 id="toc_5">修改kernel</h3>

<pre><code>
 /**
    * The application&#39;s global HTTP middleware stack.
    *
    * These middleware are run during every request to your application.
    */
protected $middleware = [
        //追加2项
        \App\Http\Middleware\LogBefore::class,  
        \App\Http\Middleware\LogAfter::class,   
    ];

</code></pre>

<h3 id="toc_6">调用实例</h3>

<pre><code>
 LogWrite::info([&quot;test&quot;=&gt;&quot;测试请求&quot;]);
 LogWrite::error([&quot;test&quot;=&gt;&quot;error&quot;]);
 LogWrite::exception(new \Exception(),[&quot;test&quot;=&gt;&quot;exception&quot;]);
 

</code></pre>

<h3 id="toc_7">日志信息</h3>

<pre><code>生成2个文件
xxx 为中心的名称（为了elk接入之后方便区分是哪个中心的日志）
xxx.info

[2017-11-03 10:46:00] info.INFO: {&quot;host&quot;:&quot;localhost&quot;,&quot;user-agent&quot;:&quot;Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/61.0.3163.100 Safari\/537.36&quot;,&quot;accept&quot;:&quot;text\/html,application\/xhtml+xml,application\/xml;q=0.9,image\/webp,image\/apng,*\/*;q=0.8&quot;,&quot;content-type&quot;:&quot;&quot;,&quot;type&quot;:&quot;request&quot;,&quot;data&quot;:[],&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  
[2017-11-03 10:46:00] info.INFO: {&quot;test&quot;:&quot;测试请求&quot;,&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  
[2017-11-03 10:46:00] info.INFO: {&quot;host&quot;:&quot;localhost&quot;,&quot;user-agent&quot;:&quot;Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/61.0.3163.100 Safari\/537.36&quot;,&quot;accept&quot;:&quot;text\/html,application\/xhtml+xml,application\/xml;q=0.9,image\/webp,image\/apng,*\/*;q=0.8&quot;,&quot;content-type&quot;:&quot;&quot;,&quot;type&quot;:&quot;response&quot;,&quot;data&quot;:{&quot;hello&quot;:&quot;word&quot;},&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  


xxx.error  

exception 只是组装自己的参数，最后还是调用error方法 ，所以日志有2条

[2017-11-03 10:46:00] error.ERROR: {&quot;test&quot;:&quot;error&quot;,&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  
[2017-11-03 10:46:00] error.ERROR: {&quot;type&quot;:&quot;error&quot;,&quot;remoteAddr&quot;:&quot;::1&quot;,&quot;remotePort&quot;:&quot;62126&quot;,&quot;referer&quot;:&quot;&quot;,&quot;url&quot;:&quot;http:\/\/localhost\/eking_platformwallet_center\/public\/test&quot;,&quot;input&quot;:[],&quot;message&quot;:&quot;&quot;,&quot;file&quot;:&quot;\/Users\/shuo\/w3c\/eking_platformwallet_center\/app\/Http\/Controllers\/TestController.php&quot;,&quot;line&quot;:14,&quot;code&quot;:0,&quot;trace&quot;:[],&quot;exceptionClass&quot;:&quot;Exception&quot;,&quot;guid&quot;:&quot;B80EA6D2-F75D-AA87-0DDC-BCB9B83B6C21&quot;}  



</code></pre>


			
			
		</div>

	</article>
  

</div>
<nav id="pagenavi">
	 <a class="prev" href="all_7.html">Prev</a>  
	 <a class="next" href="all_9.html">Next</a> 
	<div class="center"><a href="archives.html">Blog Archives</a></div>

</nav>

</div>



        </div>
			<footer id="footer" class="inner">Copyright &copy; 2014
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; 
Theme by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
      </footer>
		</div>
	</div>

  
    
<script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

</body>
</html>